{
  "id": "snapshot_1765809990764_r0cqxmw4m",
  "approvalId": "approval_1765809951025_bvfc8pwho",
  "approvalTitle": "Structure Steering Document",
  "version": 2,
  "timestamp": "2025-12-15T14:46:30.764Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\ncode-viz/\n├── src-tauri/                      # Rust backend (Tauri application)\n│   ├── src/\n│   │   ├── main.rs                 # Application entry point\n│   │   ├── lib.rs                  # Library exports for plugin system\n│   │   ├── commands/               # Tauri command handlers\n│   │   │   ├── mod.rs\n│   │   │   ├── analysis.rs         # Analysis-related commands\n│   │   │   ├── git.rs              # Git history commands\n│   │   │   └── config.rs           # Configuration commands\n│   │   ├── analysis/               # Analysis engine core\n│   │   │   ├── mod.rs\n│   │   │   ├── parser.rs           # Tree-sitter wrapper\n│   │   │   ├── metrics.rs          # Complexity calculations\n│   │   │   ├── graph.rs            # Stack-graphs integration\n│   │   │   └── dead_code.rs        # Dead code detection\n│   │   ├── git/                    # Git integration\n│   │   │   ├── mod.rs\n│   │   │   ├── history.rs          # Commit history traversal\n│   │   │   ├── diff.rs             # Diff analysis\n│   │   │   └── churn.rs            # Churn metrics\n│   │   ├── cache/                  # Caching layer\n│   │   │   ├── mod.rs\n│   │   │   ├── memory.rs           # In-memory cache\n│   │   │   └── disk.rs             # Disk-backed cache (sled/SQLite)\n│   │   ├── models/                 # Data models (shared with frontend via specta)\n│   │   │   ├── mod.rs\n│   │   │   ├── metrics.rs          # Metric data structures\n│   │   │   ├── graph.rs            # Graph data structures\n│   │   │   └── events.rs           # Event types for IPC\n│   │   └── utils/                  # Utility functions\n│   │       ├── mod.rs\n│   │       └── logging.rs          # Tracing setup\n│   ├── Cargo.toml                  # Rust dependencies\n│   ├── tauri.conf.json             # Tauri configuration\n│   ├── build.rs                    # Build script (specta codegen)\n│   └── icons/                      # Application icons\n│\n├── src/                            # React frontend\n│   ├── main.tsx                    # React entry point\n│   ├── App.tsx                     # Root component\n│   ├── bindings.ts                 # Auto-generated Tauri bindings (from specta)\n│   ├── components/                 # Reusable UI components\n│   │   ├── layout/\n│   │   │   ├── AppLayout.tsx\n│   │   │   ├── Sidebar.tsx\n│   │   │   └── Toolbar.tsx\n│   │   ├── visualizations/\n│   │   │   ├── Treemap.tsx         # 2D treemap (ECharts)\n│   │   │   ├── CodeCity.tsx        # 3D code city (R3F)\n│   │   │   ├── Timeline.tsx        # Git history timeline\n│   │   │   └── MetricsPanel.tsx    # Metrics display\n│   │   └── common/\n│   │       ├── Button.tsx\n│   │       ├── Modal.tsx\n│   │       └── Tooltip.tsx\n│   ├── features/                   # Feature-based modules\n│   │   ├── analysis/\n│   │   │   ├── AnalysisView.tsx\n│   │   │   ├── useAnalysis.ts      # Custom hook\n│   │   │   └── types.ts\n│   │   ├── history/\n│   │   │   ├── HistoryView.tsx\n│   │   │   ├── useHistory.ts\n│   │   │   └── types.ts\n│   │   └── settings/\n│   │       ├── SettingsView.tsx\n│   │       └── useSettings.ts\n│   ├── hooks/                      # Shared custom hooks\n│   │   ├── useTauriCommand.ts      # Wrapper for IPC calls\n│   │   ├── useTauriEvent.ts        # Event subscription hook\n│   │   └── useFileWatcher.ts\n│   ├── store/                      # State management (Zustand)\n│   │   ├── index.ts\n│   │   ├── analysisStore.ts\n│   │   └── uiStore.ts\n│   ├── utils/                      # Frontend utilities\n│   │   ├── formatting.ts           # Number/date formatting\n│   │   ├── colors.ts               # Color mapping for metrics\n│   │   └── validation.ts\n│   ├── styles/                     # Global styles\n│   │   └── globals.css             # Tailwind imports\n│   └── types/                      # TypeScript type definitions\n│       └── index.ts\n│\n├── crates/                         # Optional: Workspace crates (if modularizing Rust)\n│   ├── code-viz-analysis/          # Analysis engine as library\n│   │   ├── src/\n│   │   │   └── lib.rs\n│   │   ├── Cargo.toml\n│   │   └── README.md\n│   ├── code-viz-git/               # Git integration as library\n│   │   ├── src/\n│   │   │   └── lib.rs\n│   │   ├── Cargo.toml\n│   │   └── README.md\n│   └── code-viz-models/            # Shared data models\n│       ├── src/\n│       │   └── lib.rs\n│       ├── Cargo.toml\n│       └── README.md\n│\n├── tests/                          # Integration and E2E tests\n│   ├── integration/                # Rust integration tests\n│   │   ├── analysis_tests.rs\n│   │   └── git_tests.rs\n│   └── e2e/                        # Playwright E2E tests\n│       ├── treemap.spec.ts\n│       └── timeline.spec.ts\n│\n├── benchmarks/                     # Performance benchmarks\n│   ├── analysis_bench.rs\n│   └── parsing_bench.rs\n│\n├── docs/                           # Documentation\n│   ├── architecture.md             # High-level architecture\n│   ├── api/                        # API documentation\n│   ├── search.md                   # Original specification\n│   └── fast-iteration.md           # Development workflow doc\n│\n├── scripts/                        # Build and utility scripts\n│   ├── generate-llm-context.sh     # Generate LLM.md\n│   └── setup-dev.sh                # Dev environment setup\n│\n├── .zellij/                        # Zellij terminal layouts\n│   └── layout.kdl\n│\n├── .cargo/                         # Cargo configuration\n│   └── config.toml                 # Linker settings (mold)\n│\n├── .vscode/                        # VSCode settings\n│   └── settings.json               # rust-analyzer config\n│\n├── .spec-workflow/                 # Spec workflow (steering docs)\n│   ├── steering/\n│   │   ├── product.md\n│   │   ├── tech.md\n│   │   └── structure.md\n│   └── templates/\n│\n├── .cursorrules                    # AI agent guidelines\n├── LLM.md                          # Auto-generated AI context\n├── Justfile                        # Task runner recipes\n├── Cargo.toml                      # Workspace root (if using crates/)\n├── package.json                    # Frontend dependencies\n├── vite.config.ts                  # Vite configuration\n├── tailwind.config.js              # Tailwind CSS config\n├── tsconfig.json                   # TypeScript configuration\n├── .gitignore\n└── README.md\n```\n\n## Naming Conventions\n\n### Files\n\n#### Rust (Backend)\n- **Modules**: `snake_case.rs` (e.g., `dead_code.rs`, `git_history.rs`)\n- **Tests**: `#[cfg(test)] mod tests` inline or `tests/` directory with `_test.rs` suffix\n- **Binary**: `main.rs` (application entry point)\n- **Library**: `lib.rs` (library exports)\n\n#### TypeScript/React (Frontend)\n- **Components**: `PascalCase.tsx` (e.g., `Treemap.tsx`, `CodeCity.tsx`)\n- **Hooks**: `camelCase.ts` with `use` prefix (e.g., `useAnalysis.ts`, `useTauriCommand.ts`)\n- **Utilities**: `camelCase.ts` (e.g., `formatting.ts`, `colors.ts`)\n- **Tests**: `[filename].test.ts` or `[filename].spec.ts`\n- **Types**: `types.ts` or `index.ts` (for barrel exports)\n\n### Code\n\n#### Rust\n- **Structs/Enums**: `PascalCase` (e.g., `CodeMetric`, `AnalysisResult`)\n- **Traits**: `PascalCase` (e.g., `MetricCalculator`, `Parser`)\n- **Functions**: `snake_case` (e.g., `calculate_complexity`, `parse_file`)\n- **Constants**: `SCREAMING_SNAKE_CASE` (e.g., `MAX_FILE_SIZE`, `DEFAULT_TIMEOUT`)\n- **Lifetimes**: `'a`, `'b` (lowercase single letters)\n- **Generics**: `T`, `U`, `Item` (descriptive or single uppercase letters)\n\n#### TypeScript/React\n- **Interfaces/Types**: `PascalCase` (e.g., `AnalysisResult`, `MetricData`)\n- **Functions**: `camelCase` (e.g., `calculateComplexity`, `formatBytes`)\n- **React Components**: `PascalCase` (e.g., `Treemap`, `CodeCity`)\n- **Constants**: `SCREAMING_SNAKE_CASE` or `camelCase` (e.g., `MAX_NODES` or `maxNodes`)\n- **Variables**: `camelCase` (e.g., `fileCount`, `metricData`)\n- **Enum Values**: `PascalCase` (e.g., `MetricType.CognitiveComplexity`)\n\n## Import Patterns\n\n### Rust Import Order\n1. Standard library (`use std::...`)\n2. External crates (`use serde::...`, `use tauri::...`)\n3. Workspace crates (`use code_viz_analysis::...`)\n4. Local modules (`use crate::...`, `use super::...`)\n\n**Example:**\n```rust\nuse std::path::PathBuf;\nuse std::sync::Arc;\n\nuse serde::{Deserialize, Serialize};\nuse tauri::command;\nuse tree_sitter::Parser;\n\nuse crate::models::CodeMetric;\nuse crate::utils::logging::setup_tracing;\n\nuse super::parser::parse_file;\n```\n\n### TypeScript Import Order\n1. React core (`import React from 'react'`)\n2. External libraries (`import { Canvas } from '@react-three/fiber'`)\n3. Internal components/features (`import { Treemap } from '@/components'`)\n4. Hooks and stores (`import { useAnalysis } from '@/hooks'`)\n5. Utilities and types (`import { formatBytes } from '@/utils'`)\n6. Styles (`import './styles.css'`)\n\n**Path Aliases** (configured in tsconfig.json):\n- `@/` → `src/`\n- `@components/` → `src/components/`\n- `@hooks/` → `src/hooks/`\n- `@store/` → `src/store/`\n\n**Example:**\n```typescript\nimport React, { useEffect, useState } from 'react';\n\nimport { Canvas } from '@react-three/fiber';\nimport { OrbitControls } from '@react-three/drei';\n\nimport { Treemap } from '@/components/visualizations';\nimport { useAnalysis } from '@/hooks/useAnalysis';\nimport { analysisStore } from '@/store';\n\nimport { formatBytes } from '@/utils/formatting';\nimport type { AnalysisResult } from '@/types';\n\nimport './CodeCity.css';\n```\n\n## Code Structure Patterns\n\n### Rust Module Organization\n\n```rust\n// 1. Imports (grouped by origin)\nuse std::collections::HashMap;\nuse serde::Serialize;\nuse crate::models::CodeMetric;\n\n// 2. Constants and static configuration\nconst MAX_COMPLEXITY_THRESHOLD: u32 = 50;\n\n// 3. Type definitions (structs, enums, type aliases)\n#[derive(Debug, Clone, Serialize)]\npub struct ComplexityCalculator {\n    threshold: u32,\n    cache: HashMap<String, u32>,\n}\n\n// 4. Trait definitions\npub trait MetricCalculator {\n    fn calculate(&self, code: &str) -> Result<u32, Error>;\n}\n\n// 5. Main implementation blocks\nimpl ComplexityCalculator {\n    pub fn new(threshold: u32) -> Self {\n        Self {\n            threshold,\n            cache: HashMap::new(),\n        }\n    }\n}\n\n// 6. Trait implementations\nimpl MetricCalculator for ComplexityCalculator {\n    fn calculate(&self, code: &str) -> Result<u32, Error> {\n        // Implementation\n    }\n}\n\n// 7. Private helper functions\nfn normalize_score(score: u32) -> f64 {\n    // Helper logic\n}\n\n// 8. Tests\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_complexity_calculation() {\n        // Test logic\n    }\n}\n```\n\n### React Component Organization\n\n```typescript\n// 1. Imports\nimport React, { useState, useEffect } from 'react';\nimport { useAnalysis } from '@/hooks/useAnalysis';\n\n// 2. Types/Interfaces\ninterface TreemapProps {\n  data: AnalysisResult;\n  onNodeClick?: (nodeId: string) => void;\n}\n\n// 3. Constants\nconst DEFAULT_COLOR_SCHEME = ['#22c55e', '#eab308', '#ef4444'];\n\n// 4. Component definition\nexport const Treemap: React.FC<TreemapProps> = ({ data, onNodeClick }) => {\n  // 4a. State hooks\n  const [selectedNode, setSelectedNode] = useState<string | null>(null);\n\n  // 4b. Custom hooks\n  const { metrics, isLoading } = useAnalysis();\n\n  // 4c. Side effects\n  useEffect(() => {\n    // Setup logic\n    return () => {\n      // Cleanup\n    };\n  }, [data]);\n\n  // 4d. Event handlers\n  const handleNodeClick = (nodeId: string) => {\n    setSelectedNode(nodeId);\n    onNodeClick?.(nodeId);\n  };\n\n  // 4e. Render helpers\n  const renderNode = (node: Node) => {\n    // Render logic\n  };\n\n  // 4f. Early returns\n  if (isLoading) return <Loading />;\n  if (!data) return <EmptyState />;\n\n  // 4g. Main render\n  return (\n    <div className=\"treemap-container\">\n      {/* JSX */}\n    </div>\n  );\n};\n\n// 5. Display name (for debugging)\nTreemap.displayName = 'Treemap';\n\n// 6. Default export (if applicable)\nexport default Treemap;\n```\n\n### Function Organization Principles\n\n```rust\n// Example: Well-organized function\npub fn analyze_repository(\n    repo_path: PathBuf,\n    options: AnalysisOptions,\n) -> Result<AnalysisResult, AnalysisError> {\n    // 1. Input validation\n    if !repo_path.exists() {\n        return Err(AnalysisError::InvalidPath(repo_path));\n    }\n\n    // 2. Setup/initialization\n    let parser = Parser::new()?;\n    let mut metrics = Vec::new();\n\n    // 3. Core logic\n    for file in discover_files(&repo_path)? {\n        let metric = calculate_file_metrics(&file, &parser)?;\n        metrics.push(metric);\n    }\n\n    // 4. Aggregation/post-processing\n    let summary = aggregate_metrics(&metrics);\n\n    // 5. Return result\n    Ok(AnalysisResult {\n        metrics,\n        summary,\n        timestamp: Utc::now(),\n    })\n}\n```\n\n## Code Organization Principles\n\n### SOLID Principles (Enforced)\n\n1. **Single Responsibility**: Each module/file has ONE clear purpose\n   - `parser.rs` only handles parsing (not metrics or visualization)\n   - `Treemap.tsx` only renders treemap (not data fetching or state management)\n\n2. **Open/Closed**: Extend via traits/interfaces, not modification\n   - Use trait `MetricCalculator` for new metrics (don't modify existing calculators)\n\n3. **Liskov Substitution**: Implementations must be interchangeable\n   - Any `MetricCalculator` implementation works in analysis pipeline\n\n4. **Interface Segregation**: Small, focused traits/interfaces\n   - Don't create `SuperAnalyzer` trait; use `Parser`, `MetricCalculator`, `Grapher` separately\n\n5. **Dependency Injection**: All external deps (APIs, DBs) injected\n   - Pass `Parser` as parameter, don't create inside function\n   - Mock-friendly for testing\n\n### DRY (Don't Repeat Yourself)\n- Shared Rust logic → Extract to `utils/` or create workspace crate\n- Shared React logic → Custom hooks or utility functions\n- Duplicate constants → Move to config file or shared module\n\n### KISS (Keep It Simple, Stupid)\n- Prefer flat structures over deep nesting\n- Avoid premature abstraction (wait for 3rd use case before generalizing)\n- No \"clever\" one-liners; readability > brevity\n\n### SLAP (Single Level of Abstraction Principle)\n- Functions should operate at one abstraction level\n- Mix of high-level (`analyze_repository()`) and low-level (`read_file()`) is confusing\n- Extract helpers to maintain consistent abstraction\n\n## Module Boundaries\n\n### Backend Module Dependencies\n\n```\ncommands/          → analysis/, git/, cache/     (orchestration layer)\nanalysis/          → models/                      (business logic)\ngit/               → models/                      (business logic)\ncache/             → models/                      (infrastructure)\nmodels/            → (no dependencies)            (pure data)\nutils/             → (minimal dependencies)       (utilities)\n```\n\n**Rules:**\n- Commands orchestrate; don't put business logic in commands\n- Analysis/Git modules are independent (don't cross-reference)\n- Models are pure data structures (no I/O, no business logic)\n\n### Frontend Module Dependencies\n\n```\nfeatures/          → components/, hooks/, store/ (feature modules)\ncomponents/        → hooks/, utils/              (UI building blocks)\nhooks/             → store/, bindings.ts         (state/IPC access)\nstore/             → bindings.ts                 (state management)\nutils/             → (no dependencies)           (pure functions)\nbindings.ts        → (auto-generated)            (IPC layer)\n```\n\n**Rules:**\n- Features compose components and hooks; don't put UI logic in hooks\n- Components call hooks for data; no direct IPC calls from components\n- Hooks encapsulate IPC and state access\n- Store is the single source of truth for global state\n\n### Public API vs Internal\n\n**Rust:**\n- `pub` items in `lib.rs` or `mod.rs` → Public API\n- `pub(crate)` → Internal to crate\n- No `pub` → Private to module\n\n**TypeScript:**\n- Named exports in `index.ts` (barrel file) → Public API\n- Direct imports from files → Internal usage (discouraged outside module)\n\n## Code Size Guidelines (KPIs)\n\n### File Size (excluding comments/blank lines)\n- **Maximum**: 500 lines per file\n- **Ideal**: 200-300 lines\n- **Action**: If >500 lines, split into sub-modules\n\n### Function/Method Size\n- **Maximum**: 50 lines per function\n- **Ideal**: 10-20 lines\n- **Action**: Extract helpers or refactor into smaller functions\n\n### Complexity Limits\n- **Cyclomatic Complexity**: Max 10 per function\n- **Cognitive Complexity**: Max 15 per function (measured by our own tool!)\n- **Nesting Depth**: Max 4 levels\n\n### Test Coverage\n- **Minimum**: 80% line coverage\n- **Critical Paths**: 90% coverage (analysis engine, dead code detection)\n- **Action**: Pre-commit hook fails if coverage drops below threshold\n\n### Enforcement\n- Pre-commit hooks run:\n  - `cargo clippy -- -D warnings` (Rust)\n  - `eslint --max-warnings 0` (TypeScript)\n  - `cargo test` (unit tests)\n  - Custom script to check file LOC (<500)\n\n## Tauri-Specific Patterns\n\n### IPC Command Pattern\n\n**Rust (Backend):**\n```rust\n// src-tauri/src/commands/analysis.rs\nuse crate::models::CodeMetric;\nuse tauri::State;\n\n#[tauri::command]\n#[specta::specta] // Generates TypeScript types\npub async fn get_metrics(\n    repo_path: String,\n    state: State<'_, AppState>,\n) -> Result<Vec<CodeMetric>, String> {\n    // Implementation\n}\n```\n\n**TypeScript (Frontend):**\n```typescript\n// Auto-generated from Rust via tauri-specta\nimport { commands } from './bindings';\n\n// Type-safe, no string literals!\nconst metrics = await commands.getMetrics('/path/to/repo');\n```\n\n### Event Pattern\n\n**Rust (Backend):**\n```rust\nuse tauri::Manager;\n\n// Emit event\napp_handle.emit_all(\"analysis-progress\", ProgressEvent::FileProcessed(path))?;\n```\n\n**TypeScript (Frontend):**\n```typescript\nimport { listen } from '@tauri-apps/api/event';\n\n// Subscribe to events\nconst unlisten = await listen<ProgressEvent>('analysis-progress', (event) => {\n  console.log('Progress:', event.payload);\n});\n```\n\n## Documentation Standards\n\n### Rust Documentation\n- **Public items**: MUST have `///` doc comments with examples\n- **Module-level**: `//!` at top of `mod.rs` explaining module purpose\n- **Complex logic**: Inline `//` comments explaining \"why\", not \"what\"\n\n**Example:**\n```rust\n/// Calculates cognitive complexity of a Rust function.\n///\n/// Cognitive complexity measures how difficult code is to understand,\n/// weighting nested structures more heavily than sequential code.\n///\n/// # Arguments\n/// * `ast` - The abstract syntax tree node representing the function\n///\n/// # Returns\n/// The cognitive complexity score (higher = more complex)\n///\n/// # Examples\n/// ```\n/// let ast = parse_function(\"fn foo() { if x { if y { } } }\");\n/// let score = calculate_cognitive_complexity(&ast);\n/// assert_eq!(score, 3); // 1 + (1+1) for nested ifs\n/// ```\npub fn calculate_cognitive_complexity(ast: &AstNode) -> u32 {\n    // Implementation\n}\n```\n\n### TypeScript Documentation\n- **Public components/functions**: JSDoc comments\n- **Complex hooks**: Document side effects and dependencies\n- **Types**: Descriptive names + comments for non-obvious fields\n\n**Example:**\n```typescript\n/**\n * Hook for managing code analysis operations.\n *\n * Handles IPC communication with Rust backend, caching results,\n * and providing real-time updates via events.\n *\n * @param repoPath - Absolute path to the Git repository\n * @returns Analysis state and control functions\n *\n * @example\n * ```tsx\n * const { metrics, isLoading, refetch } = useAnalysis('/path/to/repo');\n *\n * if (isLoading) return <Spinner />;\n * return <Treemap data={metrics} />;\n * ```\n */\nexport function useAnalysis(repoPath: string) {\n  // Implementation\n}\n```\n\n### README Requirements\n- **Root README.md**: Project overview, installation, quick start\n- **Module READMEs** (e.g., `src-tauri/src/analysis/README.md`):\n  - Purpose: What this module does\n  - Architecture: How it fits in the system\n  - Key APIs: Main entry points\n  - Invariants: Assumptions that must hold\n\n## Special Files\n\n### .cursorrules (AI Agent Guidelines)\n- Located at project root\n- Contains rules for AI code generation (architecture constraints, style)\n- Updated whenever architectural decisions change\n\n### LLM.md (AI Context File)\n- Auto-generated via `just generate-llm-context`\n- Contains project structure, public API signatures, invariants\n- Regenerated before major AI-assisted refactoring sessions\n\n### Justfile (Task Runner)\n- All common tasks defined as recipes\n- Replaces npm scripts for cross-cutting concerns\n- Examples: `just dev`, `just test`, `just codegen`, `just release`\n\n### .cargo/config.toml\n- Linker configuration (mold on Linux, lld on macOS/Windows)\n- Environment variables synced with Tauri config\n- Build flags for optimization\n\n## Future Structure Evolution\n\nAs the project grows, consider:\n\n1. **Workspace Crates**: Move `analysis/`, `git/` to `crates/` as standalone libraries\n2. **Plugin System**: Add `plugins/` directory for user-extensible metrics\n3. **CLI Binary**: Separate `src-cli/` for command-line interface (reuses backend libs)\n4. **Cloud Backend** (if needed): New crate `code-viz-server/` for remote indexing\n5. **Documentation Site**: `docs-site/` with Docusaurus for user-facing docs\n",
  "fileStats": {
    "size": 22468,
    "lines": 662,
    "lastModified": "2025-12-15T14:45:40.164Z"
  },
  "comments": []
}